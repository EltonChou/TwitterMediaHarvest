name: Release

concurrency:
  group: ${{github.workflow}}-${{ github.ref }}
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      version-strategy:
        description: 'Version bump strategy'
        type: choice
        required: true
        options:
          - patch
          - minor
          - major
          - none

env:
  artifact_name: pkg-${{ github.run_id }}

jobs:
  generate_artifact:
    name: Generate Artifact
    runs-on: ubuntu-latest
    environment: release
    timeout-minutes: 30
    outputs:
      xpi-name: ${{ steps.xpi-filename.outputs.filename }}
      semantic-version: ${{ steps.target-version.outputs.version }}
      version-tag: ${{ steps.target-version.outputs.version_tag }}
      changelog: ${{ steps.changelog.outputs.release }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check env file
        shell: bash
        run: |
          echo "${{ secrets.ENV_FILE }}" | base64 -d >> .env
          if ! grep -q "DSN" .env; then
            echo "error: DSN not found in .env file" >&2
            exit 1
          fi

      - name: Enable corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4.4.0
        with:
          node-version: '22.x'
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock' # Cache all workspaces' yarn.lock

      - name: Install Dependencies
        run: yarn install --immutable

      - name: Run Tests
        run: |
          yarn lint
          yarn ci:all
          yarn check:all

      - name: Bump version
        if: ${{ inputs.version-strategy != 'none' }}
        id: bump-version
        run: |
          OLD_VERSION=$(jq -r .version package.json)
          yarn version ${{ inputs.version-strategy }}
          NEW_VERSION=$(jq -r .version package.json)
          echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Confirm version
        id: target-version
        shell: bash
        run: |
          if [ "${{ inputs.version-strategy }}" = "none" ]; then
            VERSION=$(jq -r .version package.json)
            echo "No version bump selected, using existing version $VERSION"
          else
            VERSION=${{ steps.bump-version.outputs.new_version }}
            echo "Bumped version to $VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Make changelog
        if: ${{ inputs.version-strategy != 'none' }}
        run: |
          yarn changelog --release ${{ steps.target-version.outputs.version }}

      - name: Extract Changelog
        id: changelog
        uses: zogot/kacl-parser@1.0.0
        with:
          version: ${{ steps.target-version.outputs.version }}

      - name: Setup git
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit
        shell: bash
        run: |
          if [ "${{ inputs.version-strategy }}" = "none" ]; then
            git add package.json CHANGELOG.md
            git commit -m "version: bump version to ${{ steps.target-version.outputs.version }}"
          fi

          if [ -n "${{ steps.changelog.outputs.release }}" ]; then
            git tag -fa "${{ steps.target-version.outputs.version_tag }}" -m "version: bump version to ${{ steps.target-version.outputs.version }}" -m "" -m "${{ steps.changelog.outputs.release }}"
          else
            git tag -fa "${{ steps.target-version.outputs.version_tag }}" -m "version: bump version to ${{ steps.target-version.outputs.version }}"
          fi

      - name: Build
        run: yarn build:all

      - name: Push commit and tag atomically
        shell: bash
        run: |
          if [ "${{ inputs.version-strategy }}" = "none" ]; then
            git push --delete origin ${{ steps.target-version.outputs.version_tag }}
          fi

          git push --atomic origin main ${{ steps.target-version.outputs.version_tag }}

      - name: Make xpi filename
        id: xpi-filename
        run: |
          echo "filename=mediaharvest@mediaharvest.app-${{ steps.target-version.outputs.version_tag }}.xpi" >> $GITHUB_OUTPUT

      - name: Sign Firefox xpi
        continue-on-error: true
        run: |
          yarn web-ext sign -s build/firefox-signed -a dist --ignore-files "*.map" --channel unlisted --api-key ${{ secrets.FF_JWT_ISSUER }} --api-secret ${{ secrets.FF_JWT_SECRET }}
          mv dist/*.xpi dist/${{ steps.xpi-filename.outputs.filename }}

      - name: Create Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.artifact_name }}
          path: |
            dist/
            build/
          if-no-files-found: error
          retention-days: 7

  github_release:
    name: Create Github Release
    environment: release
    runs-on: ubuntu-latest
    needs: generate_artifact
    outputs:
      xpi-url: ${{ steps.xpi-url.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Download Artifact
        id: download-artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.artifact_name }}

      - name: Create Repository Release
        id: create-release
        uses: ncipollo/release-action@v1
        with:
          name: 'TwitterMediaHarvest ${{ needs.generate_artifact.outputs.version-tag }}'
          artifacts: ${{ format('{0}/dist/*.zip,{0}/dist/*.xpi', steps.download-artifact.outputs.download-path) }}
          token: ${{ secrets.GITHUB_TOKEN }}
          body: ${{ needs.generate_artifact.outputs.changelog }}
          tag: ${{ needs.generate_artifact.outputs.version-tag }}

      - name: Extract xpi url
        if: steps.create-release.outputs.id != ''
        id: xpi-url
        shell: bash
        run: |
          assets='${{ steps.create-release.outputs.assets }}'
          if [ -z "$assets" ]; then
            echo "error: release assets data is empty" >&2
            exit 1
          fi
          url=$(echo "$assets" | jq -r 'to_entries[] | select(.key | endswith(".xpi")) | .value' | head -n1)
          if [ -z "$url" ]; then
            echo "error: no .xpi url found in assets" >&2
            exit 1
          fi
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "Found XPI URL: $url"

      - name: Rollback Release
        if: failure() && steps.create-release.outputs.id != ''
        uses: author/action-rollback@stable
        with:
          release_id: ${{ steps.create-release.outputs.id }}
          tag: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sentry_release:
    name: Create Sentry Release
    environment: release
    runs-on: ubuntu-latest
    needs: generate_artifact
    strategy:
      matrix:
        target: ['chrome', 'edge', 'firefox']

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4.4.0
        with:
          node-version: '22.x'

      - name: Make release name
        id: release-name
        run: |
          echo "release=$(node ./utils/make-release-name.mjs --browser=${{ matrix.target }})" >> $GITHUB_OUTPUT

      - name: Download Artifact
        id: download-artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.artifact_name }}

      - name: Create Sentry release for ${{ matrix.target }}
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          # SENTRY_URL: https://sentry.io/
        with:
          version: ${{ steps.release-name.outputs.release }}
          url_prefix: '~/'
          environment: production
          sourcemaps: ${{ format('{0}/build/{1}', steps.download-artifact.outputs.download-path, matrix.target) }}

  chrome_release:
    name: Release to Chrome Web Store
    environment: release
    runs-on: ubuntu-latest
    needs:
      - generate_artifact
      - sentry_release

    steps:
      - uses: actions/checkout@v4

      - name: Download Artifact
        id: download_artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.artifact_name }}

      - name: Get file path
        id: get_filepath
        run: |
          echo "zip_file=$(ls ${{ steps.download_artifact.outputs.download-path }}/dist/*chrome*)" >> $GITHUB_OUTPUT

      - name: Publish to Chrome Web Store
        uses: mobilefirstllc/cws-publish@latest
        with:
          action: 'publish'
          client_id: ${{ secrets.CWS_CLIENT }}
          client_secret: ${{ secrets.CWS_SECRET }}
          refresh_token: ${{ secrets.CWS_TOKEN }}
          extension_id: hpcgabhdlnapolkkjpejieegfpehfdok
          zip_file: ${{ steps.get_filepath.outputs.zip_file }}

  # firefox_release:
  #   name: Release to Firefox Addons Store
  #   runs-on: ubuntu-latest
  #   environment: release
  #   needs:
  #     - generate_artifact
  #     - sentry_release

  #   steps:
  #     - uses: actions/checkout@v3

  #     - name: Download Artifact
  #       id: download_artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: ${{ env.artifact_name }}

  #     - name: Get file path
  #       id: get_filepath
  #       run: |
  #         echo "zip_file=$(ls ${{ steps.download_artifact.outputs.download-path }}/dist/*firefox*)" >> $GITHUB_OUTPUT

  #     - name: Archive source code
  #       id: archive_source_code
  #       run: |
  #         ZIP_NAME=source.zip
  #         git archive --format zip --add-file .env -o $ZIP_NAME HEAD
  #         echo "zip_file=$ZIP_NAME" >> $GITHUB_OUTPUT

  #     - name: Upload to Firefox addons store
  #       uses: cardinalby/webext-buildtools-firefox-addons-action@v1
  #       with:
  #         zipFilePath: ${{ steps.get_filepath.outputs.zip_file }}
  #         extensionId: 'mediaharvest@addons.mozilla.org'
  #         jwtIssuer: ${{ secrets.FF_JWT_ISSUER }}
  #         jwtSecret: ${{ secrets.FF_JWT_SECRET }}
  #         sourcesZipFilePath: ${{ steps.archive_source_code.outputs.zip_file }}

  xpi_release:
    name: XPI Release
    runs-on: ubuntu-latest
    environment: release
    needs:
      - github_release
      - generate_artifact

    steps:
      - uses: actions/checkout@v4

      - name: Create Gecko Release
        uses: ./.github/actions/create-gecko-release
        with:
          endpoint: ${{ secrets.GECKO_RELEASE_ENDPOINT }}
          id: mediaharvest@mediaharvest.app
          version: ${{ needs.generate_artifact.outputs.semantic-version }}
          url: ${{ needs.github_release.outputs.xpi-url }}
          api-key: ${{ secrets.RELEASE_API_KEY }}
          # min-browser-version: optional

  edge_release:
    name: Release to Edge Add-ons Store
    runs-on: ubuntu-latest
    environment: release
    needs:
      - generate_artifact
      - sentry_release

    steps:
      - uses: actions/checkout@v4

      - name: Download Artifact
        id: download-artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.artifact_name }}

      - name: Get file path
        id: get-filepath
        run: |
          echo "zip_file=$(ls ${{ steps.download-artifact.outputs.download-path }}/dist/*edge*)" >> $GITHUB_OUTPUT

      - name: Upload to Edge Add-ons Store
        uses: wdzeng/edge-addon@v2
        with:
          product-id: ${{ secrets.MS_STORE_PRODUCT_ID }}
          client-id: ${{ secrets.MS_STORE_CLIENT_ID }}
          api-key: ${{ secrets.MS_STORE_API_KEY }}
          zip-path: ${{ steps.get-filepath.outputs.zip_file }}
